<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>{{ page.title }}</title>
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">

  <style>
    /* 1. Global Resets */
    :root {
      --sidebar-bg: #e0e0e0;
      --sidebar-border: #d0d7de;
      --text-color: #24292e;
      --link-color: #0969da;
      --bg-color: #ffffff;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      /* Remove default margin so sidebar touches edge */
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
    }

    /* 2. The Layout Container (Flexbox) */
    .page-container {
      display: flex;
      min-height: 100vh;
    }

    /* 3. The Sidebar (Fixed on Left) */
    .sidebar {
      width: 280px;
      /* Fixed width */
      background-color: var(--sidebar-bg);
      /* Slightly darker background */
      border-right: 1px solid var(--sidebar-border);
      padding: 0;
      /* Remove padding from parent, moved to content */
      flex-shrink: 0;
      /* Prevent shrinking */

      /* Sticky behavior */
      position: sticky;
      top: 0;
      height: 100vh;
      /* Full height */
      display: flex;
      flex-direction: row;
      overflow: hidden;
      /* No scroll on parent */
      font-size: 0.9em;
    }

    .sidebar-content {
      flex: 1;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      padding-bottom: 150px;
    }

    .sidebar-resizer {
      width: 5px;
      /* Reduce dead zone for scrolling */
      cursor: col-resize;
      background-color: transparent;
      flex-shrink: 0;
      /* height: 100%; REMOVED, flex handles height */
      /* position: absolute; REMOVED to prevent overlap with scrollbar */
      /* right: 0; */
      /* top: 0; */
      z-index: 100;
      transition: background-color 0.2s;
    }

    .sidebar-resizer:hover,
    .sidebar-resizer.resizing {
      background-color: var(--link-color);
    }

    /* 4. The Main Content Area */
    .content {
      flex-grow: 1;
      /* Take remaining width */
      padding: 40px;
      max-width: 900px;
      /* Keep your original reading width */
      /* No margin: auto here because flex handles the layout */
      min-width: 0;
      /* Important for flex truncation */
    }

    .content img {
      max-width: 100%;
      height: auto;
    }

    /* Custom Code Block Styles */
    pre code.hljs {
      background-color: #e1e4e8 !important;
      /* Darker gray for prominence */
      border-radius: 6px;
      padding: 1rem;
    }

    /* 5. Your Existing Styles (Applied globally) */
    ul {
      list-style: none;
      padding-left: 20px;
      margin: 0;
    }

    li {
      margin: 6px 0;
    }

    a {
      text-decoration: none;
      color: var(--link-color);
    }

    a:hover {
      text-decoration: underline;
    }

    /* Optional: Style the Summary (Folder Name) */
    summary {
      outline: none;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    /* 6. Sidebar Toggle & Collapsed State */
    .sidebar-toggle {
      position: fixed;
      left: 20px;
      top: 15px;
      z-index: 1000;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      padding: 0 5px;
      transition: left 0.1s;
    }

    body.sidebar-collapsed .sidebar {
      display: none;
    }

    body.sidebar-collapsed .content {
      padding-left: 60px;
      /* Space for the toggle button when sidebar is gone */
    }

    /* Move toggle button when sidebar is visible */
    body:not(.sidebar-collapsed) .sidebar-toggle {
      position: fixed;
      left: 240px;
      /* Will be updated by JS */
      top: 15px;
    }

    /* Collapse button - sticky */
    .sidebar-actions {
      position: sticky;
      top: 0;
      background-color: var(--sidebar-bg);
      z-index: 10;
      padding: 10px 20px;
      border-bottom: 1px solid var(--sidebar-border);
    }

    .collapse-btn {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.8rem;
      background-color: var(--bg-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-color);
      transition: background-color 0.2s;
    }

    .collapse-btn:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">â˜°</button>

  <div class="page-container">

    <nav class="sidebar" id="sidebar">
      <div class="sidebar-content">
        <div style="margin-bottom: 20px; font-weight: bold; margin-right: 30px;">Documentation</div>
        <div class="sidebar-actions">
          <button class="collapse-btn" id="collapseAllBtn">Collapse All Folders</button>
        </div>
        {% include sidebar.html %}
      </div>
      <div class="sidebar-resizer" id="sidebarResizer"></div>
    </nav>

    <main class="content">
      {{ content }}
    </main>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("sidebarToggle");
      const body = document.body;
      const sidebar = document.getElementById("sidebar");
      const sidebarContent = sidebar.querySelector('.sidebar-content');
      const resizer = document.getElementById("sidebarResizer");
      const collapseAllBtn = document.getElementById("collapseAllBtn");
      const STORAGE_KEY = "sidebar_collapsed";
      const WIDTH_KEY = "sidebar_width";
      const SCROLL_KEY = "sidebar_scroll_position";
      const DEFAULT_WIDTH = 280;

      // --- Helper Functions ---
      function updateTogglePosition(width) {
        if (!body.classList.contains("sidebar-collapsed")) {
          // Position near right edge: width - approx 40px
          toggleBtn.style.left = (width - 40) + "px";
        } else {
          toggleBtn.style.left = "20px";
        }
      }

      function setSidebarWidth(width) {
        sidebar.style.width = width + "px";
        updateTogglePosition(width);
      }

      // --- 1. Restore State ---
      // Width
      let savedWidth = parseInt(localStorage.getItem(WIDTH_KEY));
      if (!savedWidth || isNaN(savedWidth)) savedWidth = DEFAULT_WIDTH;
      setSidebarWidth(savedWidth);

      // Collapsed
      if (localStorage.getItem(STORAGE_KEY) === "true") {
        body.classList.add("sidebar-collapsed");
        updateTogglePosition(savedWidth); // Resets to 20px
      } else {
        updateTogglePosition(savedWidth);
      }

      // Scroll Position (Applied to sidebar-content now)
      const savedScroll = localStorage.getItem(SCROLL_KEY);
      if (savedScroll) {
        sidebarContent.scrollTop = parseInt(savedScroll, 10);
      }

      // --- 2. Event Listeners ---

      // Toggle
      toggleBtn.addEventListener("click", function () {
        body.classList.toggle("sidebar-collapsed");
        const isCollapsed = body.classList.contains("sidebar-collapsed");
        localStorage.setItem(STORAGE_KEY, isCollapsed);

        // Update position immediately
        const currentWidth = parseInt(sidebar.style.width, 10) || DEFAULT_WIDTH;
        updateTogglePosition(currentWidth);
      });

      // Collapse All Folders (except root level)
      collapseAllBtn.addEventListener("click", function () {
        const allDetails = sidebarContent.querySelectorAll('details');
        allDetails.forEach(detail => {
          // Skip root-level folders (direct children of .file-tree)
          const isRoot = detail.parentElement.parentElement.classList.contains('file-tree');
          if (!isRoot) {
            detail.removeAttribute('open');
          }
        });
      });

      // --- Debounce Helper ---
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      // Scroll Persistence (Debounced)
      sidebarContent.addEventListener("scroll", debounce(function () {
        localStorage.setItem(SCROLL_KEY, sidebarContent.scrollTop);
      }, 200));

      // --- 3. Drag Logic ---
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        console.log("Resizer mousedown triggered");
        isResizing = true;
        resizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none'; // Prevent text selection
        e.preventDefault(); // Stop default behavior
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        // Calculate new width
        let newWidth = e.clientX;
        console.log("Resizing to:", newWidth);

        // Constraints
        if (newWidth < 150) newWidth = 150;
        if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;

        setSidebarWidth(newWidth);
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          console.log("Resizer mouseup triggered");
          isResizing = false;
          resizer.classList.remove('resizing');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';

          // Save
          const currentWidth = parseInt(sidebar.style.width, 10);
          localStorage.setItem(WIDTH_KEY, currentWidth);
        }
      });
    });
  </script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((el) => {
        // Force C++ class for all code blocks
        el.className = 'language-cpp';
        hljs.highlightElement(el);
      });
    });
  </script>
</body>

</html>