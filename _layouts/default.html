<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>{{ page.title }}</title>
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
  <style>
    /* 1. Global Resets */
    :root {
      --sidebar-bg: #e0e0e0;
      --sidebar-border: #d0d7de;
      --text-color: #24292e;
      --link-color: #0969da;
      --bg-color: #ffffff;
      --base-font-size: 16px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      /* Remove default margin so sidebar touches edge */
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: var(--base-font-size);
      padding-bottom: 60px;
      /* Space for footer */
    }

    /* Text Size Slider Footer */
    .text-size-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background-color: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding: 0 20px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      z-index: 1000;
      box-sizing: border-box;
    }

    .text-size-footer input[type=range] {
      width: 200px;
      cursor: pointer;
    }

    .reset-btn {
      padding: 5px 10px;
      font-size: 12px;
      background-color: #f6f8fa;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }

    .reset-btn:hover {
      background-color: #eef1f4;
    }

    /* Adjust sidebar height to not overlap footer */
    .sidebar {
      height: calc(100vh - 50px);
    }

    /* 2. The Layout Container (Flexbox) */
    .page-container {
      display: flex;
      min-height: 100vh;
    }

    /* 3. The Sidebar (Fixed on Left) */
    .sidebar {
      width: 280px;
      /* Fixed width */
      background-color: var(--sidebar-bg);
      /* Slightly darker background */
      border-right: 1px solid var(--sidebar-border);
      padding: 0;
      /* Remove padding from parent, moved to content */
      flex-shrink: 0;
      /* Prevent shrinking */

      /* Sticky behavior */
      position: sticky;
      top: 0;
      height: 100vh;
      /* Full height */
      display: flex;
      flex-direction: row;
      overflow: hidden;
      /* No scroll on parent */
      font-size: 0.9em;
    }

    .sidebar-content {
      flex: 1;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      padding-bottom: 150px;
    }

    .sidebar-resizer {
      width: 5px;
      /* Reduce dead zone for scrolling */
      cursor: col-resize;
      background-color: transparent;
      flex-shrink: 0;
      /* height: 100%; REMOVED, flex handles height */
      /* position: absolute; REMOVED to prevent overlap with scrollbar */
      /* right: 0; */
      /* top: 0; */
      z-index: 100;
      transition: background-color 0.2s;
    }

    .sidebar-resizer:hover,
    .sidebar-resizer.resizing {
      background-color: var(--link-color);
    }

    /* 4. The Main Content Area */
    .content {
      flex-grow: 1;
      /* Take remaining width */
      padding: 40px;
      max-width: 900px;
      /* Keep your original reading width */
      /* No margin: auto here because flex handles the layout */
      min-width: 0;
      /* Important for flex truncation */
    }

    .content img {
      max-width: 100%;
      height: auto;
    }

    /* Custom Code Block Styles */
    pre code.hljs {
      background-color: #e1e4e8 !important;
      /* Darker gray for prominence */
      border-radius: 6px;
      padding: 1rem;
    }

    /* 5. Your Existing Styles (Applied globally) */
    ul {
      list-style: none;
      padding-left: 20px;
      margin: 0;
    }

    li {
      margin: 6px 0;
    }

    a {
      text-decoration: none;
      color: var(--link-color);
    }

    a:hover {
      text-decoration: underline;
    }

    /* Optional: Style the Summary (Folder Name) */
    summary {
      outline: none;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    /* 6. Sidebar Toggle & Collapsed State */
    .sidebar-toggle {
      position: fixed;
      left: 20px;
      top: 15px;
      z-index: 1000;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      padding: 0 5px;
      transition: left 0.1s;
    }

    body.sidebar-collapsed .sidebar {
      display: none;
    }

    body.sidebar-collapsed .content {
      padding-left: 60px;
      /* Space for the toggle button when sidebar is gone */
    }

    /* Move toggle button when sidebar is visible */
    body:not(.sidebar-collapsed) .sidebar-toggle {
      position: fixed;
      left: 240px;
      /* Will be updated by JS */
      top: 15px;
    }

    /* Collapse button - sticky */
    .sidebar-actions {
      position: sticky;
      top: 0;
      background-color: rgba(224, 224, 224, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 10;
      padding: 10px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .collapse-btn {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.8rem;
      background-color: var(--bg-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-color);
      transition: background-color 0.2s;
    }

    .collapse-btn:hover {
      background-color: #f0f0f0;
    }

    /* EasyMDE Fixes */
    .EasyMDEContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      /* Critical for flex scrolling */
    }

    .CodeMirror {
      flex: 1;
      height: auto !important;
      /* Let flex handle height */
    }

    .CodeMirror-scroll {
      min-height: 0 !important;
    }
  </style>
</head>

<body>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">â˜°</button>

  <div class="page-container">

    <nav class="sidebar" id="sidebar">
      <div class="sidebar-content">

        {% include sidebar_fast.html %}
      </div>
      <div class="sidebar-resizer" id="sidebarResizer"></div>
    </nav>

    <main class="content">
      {{ content }}
    </main>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("sidebarToggle");
      const body = document.body;
      const sidebar = document.getElementById("sidebar");
      const sidebarContent = sidebar.querySelector('.sidebar-content');
      const resizer = document.getElementById("sidebarResizer");
      const collapseAllBtn = document.getElementById("collapseAllBtn");
      const STORAGE_KEY = "sidebar_collapsed";
      const WIDTH_KEY = "sidebar_width";
      const SCROLL_KEY = "sidebar_scroll_position";
      const DEFAULT_WIDTH = 280;

      // --- Helper Functions ---
      function updateTogglePosition(width) {
        if (!body.classList.contains("sidebar-collapsed")) {
          // Position near right edge: width - approx 40px
          toggleBtn.style.left = (width - 40) + "px";
        } else {
          toggleBtn.style.left = "20px";
        }
      }

      function setSidebarWidth(width) {
        sidebar.style.width = width + "px";
        updateTogglePosition(width);
      }

      // --- 1. Restore State ---
      // Width
      let savedWidth = parseInt(localStorage.getItem(WIDTH_KEY));
      if (!savedWidth || isNaN(savedWidth)) savedWidth = DEFAULT_WIDTH;
      setSidebarWidth(savedWidth);

      // Collapsed
      if (localStorage.getItem(STORAGE_KEY) === "true") {
        body.classList.add("sidebar-collapsed");
        updateTogglePosition(savedWidth); // Resets to 20px
      } else {
        updateTogglePosition(savedWidth);
      }

      // Scroll Position (Applied to sidebar-content now)
      const savedScroll = localStorage.getItem(SCROLL_KEY);
      if (savedScroll) {
        sidebarContent.scrollTop = parseInt(savedScroll, 10);
      }

      // --- 2. Event Listeners ---

      // Toggle
      toggleBtn.addEventListener("click", function () {
        body.classList.toggle("sidebar-collapsed");
        const isCollapsed = body.classList.contains("sidebar-collapsed");
        localStorage.setItem(STORAGE_KEY, isCollapsed);

        // Update position immediately
        const currentWidth = parseInt(sidebar.style.width, 10) || DEFAULT_WIDTH;
        updateTogglePosition(currentWidth);
      });



      // --- Debounce Helper ---
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      // Scroll Persistence (Debounced)
      sidebarContent.addEventListener("scroll", debounce(function () {
        localStorage.setItem(SCROLL_KEY, sidebarContent.scrollTop);
      }, 200));

      // --- 3. Drag Logic ---
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        console.log("Resizer mousedown triggered");
        isResizing = true;
        resizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none'; // Prevent text selection
        e.preventDefault(); // Stop default behavior
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        // Calculate new width
        let newWidth = e.clientX;
        console.log("Resizing to:", newWidth);

        // Constraints
        if (newWidth < 150) newWidth = 150;
        if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;

        setSidebarWidth(newWidth);
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          console.log("Resizer mouseup triggered");
          isResizing = false;
          resizer.classList.remove('resizing');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';

          // Save
          const currentWidth = parseInt(sidebar.style.width, 10);
          localStorage.setItem(WIDTH_KEY, currentWidth);
        }
      });
    });
  </script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
  <script>
    // Define helper functions globally
    window.highlightCode = function () {
      document.querySelectorAll('pre code').forEach((el) => {
        el.className = 'language-cpp';
        hljs.highlightElement(el);
      });
    };

    window.autoLinkContent = function () {
      const content = document.querySelector('.content');
      if (!content) return;

      const walker = document.createTreeWalker(
        content,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: function (node) {
            if (['A', 'SCRIPT', 'STYLE', 'PRE', 'CODE', 'TEXTAREA'].includes(node.parentNode.tagName)) {
              return NodeFilter.FILTER_REJECT;
            }
            return NodeFilter.FILTER_ACCEPT;
          }
        }
      );

      const nodes = [];
      let node;
      while (node = walker.nextNode()) nodes.push(node);

      // Regex for HTTP/HTTPS URLs
      const urlRegex = /https?:\/\/[^\s<"']+/g;

      nodes.forEach(node => {
        const text = node.nodeValue;
        if (text.indexOf('http') === -1) return;

        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        let match;

        urlRegex.lastIndex = 0;

        while ((match = urlRegex.exec(text)) !== null) {
          const url = match[0];
          const cleanUrl = url.replace(/[.,)\]]+$/, '');

          fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));

          const a = document.createElement('a');
          a.href = cleanUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = cleanUrl;
          fragment.appendChild(a);

          const stripped = url.substring(cleanUrl.length);
          if (stripped) {
            fragment.appendChild(document.createTextNode(stripped));
          }

          lastIndex = match.index + url.length;
        }

        if (lastIndex > 0) {
          if (lastIndex < text.length) {
            fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
          }
          node.parentNode.replaceChild(fragment, node);
        }
      });
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      window.highlightCode();
      window.autoLinkContent();
    });
  </script>
  <div class="text-size-footer">
    <div class="footer-left" style="position: absolute; left: 20px; display: flex; align-items: center; gap: 10px;">
      <button id="footerCollapseBtn" class="reset-btn" title="Collapse All Folders"
        style="font-size: 16px; margin: 0;">ðŸ“‚</button>
      <input type="text" id="fuzzy-search-input" placeholder="Search..."
        style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
      <div id="search-stats" style="font-size: 10px; color: #666; white-space: nowrap;"></div>
    </div>
    <span style="font-size: 12px; font-weight: bold;">A</span>
    <input type="range" id="textSizeSlider" min="12" max="28" value="16" step="1">
    <span style="font-size: 24px; font-weight: bold;">A</span>
    <button id="resetTextSize" class="reset-btn">Default</button>
    <button id="editPageBtn" class="reset-btn"
      style="margin-left: 20px; background-color: #e3f2fd; color: #0d47a1; border-color: #2196f3;">Edit Page</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const textSizeSlider = document.getElementById('textSizeSlider');
      const SIZE_KEY = "user_font_size";

      // 1. Restore State
      const savedSize = localStorage.getItem(SIZE_KEY);
      if (savedSize) {
        document.documentElement.style.setProperty('--base-font-size', savedSize + 'px');
        textSizeSlider.value = savedSize;
      }

      // 2. Listener
      textSizeSlider.addEventListener('input', function () {
        const newVal = this.value;
        document.documentElement.style.setProperty('--base-font-size', newVal + 'px');
        localStorage.setItem(SIZE_KEY, newVal);
      });

      // 3. Reset Button
      document.getElementById('resetTextSize').addEventListener('click', function () {
        const defaultSize = 16;
        document.documentElement.style.setProperty('--base-font-size', defaultSize + 'px');
        textSizeSlider.value = defaultSize;
        localStorage.setItem(SIZE_KEY, defaultSize);
      });

      // 4. Collapse All Button
      const collapseBtn = document.getElementById('footerCollapseBtn');
      if (collapseBtn) {
        collapseBtn.addEventListener('click', function () {
          // Select all details in the sidebar
          const allDetails = document.querySelectorAll('.sidebar-content details');
          allDetails.forEach(detail => {
            // Check if it is a root folder (direct child of .file-tree)
            const isRoot = detail.parentElement.parentElement.classList.contains('file-tree');

            // Option: Collapse everything that isn't the main list wrapper
            if (detail.hasAttribute('open') && !isRoot) {
              detail.removeAttribute('open');
              if (detail.id) localStorage.removeItem(detail.id);
            }
          });
        });
      }
    });
  </script>
  <!-- Editor Overlay -->
  <div id="editorOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; flex-direction:column;">
    <div
      style="padding:10px; background:#f0f0f0; border-bottom:1px solid #ccc; display:flex; gap:10px; align-items:center;">
      <span style="font-weight:bold;">Editing: <span id="editorFileName"></span></span>
      <button id="saveEditBtn" class="reset-btn" style="background:#4caf50; color:white; border:none;">Save</button>
      <button id="cancelEditBtn" class="reset-btn" style="background:#f44336; color:white; border:none;">Cancel</button>
    </div>
    <textarea id="editorTextarea"
      style="flex:1; width:100%; padding:20px; font-family:monospace; font-size:14px; border:none; resize:none; outline:none; white-space: pre;"
      spellcheck="false"></textarea>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const editBtn = document.getElementById('editPageBtn');
      const editorOverlay = document.getElementById('editorOverlay');
      const editorTextarea = document.getElementById('editorTextarea');
      const editorFileName = document.getElementById('editorFileName');
      const saveBtn = document.getElementById('saveEditBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');

      let easyMDE = null;

      // Liquid variable for current path
      const currentPath = "{{ page.path }}";

      if (editBtn) {
        editBtn.addEventListener('click', async () => {
          try {
            // Check if running on localhost/port where server is expected
            // or just try fetching
            const response = await fetch(`http://localhost:8000/api/read?path=${encodeURIComponent(currentPath)}`);
            if (!response.ok) {
              if (response.status === 404) throw new Error('File not found.');
              throw new Error('Failed to fetch. Is python scripts/edit_server.py running?');
            }
            const text = await response.text();
            editorTextarea.value = text;
            editorFileName.textContent = currentPath;
            editorOverlay.style.display = 'flex';

            // Initialize EasyMDE if not already active
            if (!easyMDE) {
              easyMDE = new EasyMDE({
                element: editorTextarea,
                spellChecker: false,
                autosave: { enabled: false },
                status: false,
                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"]
              });
            } else {
              easyMDE.value(text);
            }

          } catch (e) {
            alert("Error: " + e.message + "\n\nPlease run: python3 scripts/edit_server.py");
          }
        });
      }

      function closeEditor() {
        editorOverlay.style.display = 'none';
        if (easyMDE) {
          easyMDE.toTextArea();
          easyMDE = null;
        }
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          closeEditor();
        });
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          try {
            const originalText = saveBtn.textContent;
            saveBtn.textContent = "Saving...";

            // Get value from EasyMDE if active, else textarea
            const content = easyMDE ? easyMDE.value() : editorTextarea.value;

            const response = await fetch('http://localhost:8000/api/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: currentPath, content: content })
            });
            if (!response.ok) throw new Error('Failed to save');

            saveBtn.textContent = "Saved!";

            // Cleanup
            closeEditor();

            // Reload to see changes (Jekyll takes a moment to rebuild)
            // We'll reload after a short delay
            setTimeout(() => location.reload(), 1500);
          } catch (e) {
            alert('Error saving: ' + e.message);
            saveBtn.textContent = "Save";
          }
        });
      }
    });
  </script>
</body>

</html>