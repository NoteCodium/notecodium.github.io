<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>{{ page.title }}</title>
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">

  <style>
    /* 1. Global Resets */
    :root {
      --sidebar-bg: #e0e0e0;
      --sidebar-border: #d0d7de;
      --text-color: #24292e;
      --link-color: #0969da;
      --bg-color: #ffffff;
      --base-font-size: 16px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      /* Remove default margin so sidebar touches edge */
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: var(--base-font-size);
      padding-bottom: 60px;
      /* Space for footer */
    }

    /* Text Size Slider Footer */
    .text-size-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background-color: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding: 0 20px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      z-index: 1000;
      box-sizing: border-box;
    }

    .text-size-footer input[type=range] {
      width: 200px;
      cursor: pointer;
    }

    .reset-btn {
      padding: 5px 10px;
      font-size: 12px;
      background-color: #f6f8fa;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }

    .reset-btn:hover {
      background-color: #eef1f4;
    }

    .nav-btn {
      padding: 5px 12px;
      font-size: 12px;
      background-color: #f6f8fa;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-color);
      transition: background-color 0.2s;
    }

    .nav-btn:hover {
      background-color: #eef1f4;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn:disabled:hover {
      background-color: #f6f8fa;
    }

    /* Adjust sidebar height to not overlap footer */
    .sidebar {
      height: calc(100vh - 50px);
    }

    /* 2. The Layout Container (Flexbox) */
    .page-container {
      display: flex;
      min-height: 100vh;
    }

    /* 3. The Sidebar (Fixed on Left) */
    .sidebar {
      width: 280px;
      /* Fixed width */
      background-color: var(--sidebar-bg);
      /* Slightly darker background */
      border-right: 1px solid var(--sidebar-border);
      padding: 0;
      /* Remove padding from parent, moved to content */
      flex-shrink: 0;
      /* Prevent shrinking */

      /* Sticky behavior */
      position: sticky;
      top: 0;
      height: 100vh;
      /* Full height */
      display: flex;
      flex-direction: row;
      overflow: hidden;
      /* No scroll on parent */
      font-size: 0.9em;
    }

    .sidebar-content {
      flex: 1;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      padding-bottom: 150px;
    }

    .sidebar-resizer {
      width: 5px;
      /* Reduce dead zone for scrolling */
      cursor: col-resize;
      background-color: transparent;
      flex-shrink: 0;
      /* height: 100%; REMOVED, flex handles height */
      /* position: absolute; REMOVED to prevent overlap with scrollbar */
      /* right: 0; */
      /* top: 0; */
      z-index: 100;
      transition: background-color 0.2s;
    }

    .sidebar-resizer:hover,
    .sidebar-resizer.resizing {
      background-color: var(--link-color);
    }

    /* 4. The Main Content Area */
    .content {
      flex-grow: 1;
      /* Take remaining width */
      padding: 40px;
      max-width: 900px;
      /* Keep your original reading width */
      /* No margin: auto here because flex handles the layout */
      min-width: 0;
      /* Important for flex truncation */
    }

    .content img {
      max-width: 100%;
      height: auto;
    }

    /* Custom Code Block Styles */
    pre code.hljs {
      background-color: #e1e4e8 !important;
      /* Darker gray for prominence */
      border-radius: 6px;
      padding: 1rem;
    }

    /* 5. Your Existing Styles (Applied globally) */
    ul {
      list-style: none;
      padding-left: 20px;
      margin: 0;
    }

    li {
      margin: 6px 0;
    }

    a {
      text-decoration: none;
      color: var(--link-color);
    }

    a:hover {
      text-decoration: underline;
    }

    /* Optional: Style the Summary (Folder Name) */
    summary {
      outline: none;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    /* 6. Sidebar Toggle & Collapsed State */
    .sidebar-toggle {
      position: fixed;
      left: 20px;
      top: 15px;
      z-index: 1000;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      padding: 0 5px;
      transition: left 0.1s;
    }

    body.sidebar-collapsed .sidebar {
      display: none;
    }

    body.sidebar-collapsed .content {
      padding-left: 60px;
      /* Space for the toggle button when sidebar is gone */
    }

    /* Move toggle button when sidebar is visible */
    body:not(.sidebar-collapsed) .sidebar-toggle {
      position: fixed;
      left: 240px;
      /* Will be updated by JS */
      top: 15px;
    }

    /* Collapse button - sticky */
    .sidebar-actions {
      position: sticky;
      top: 0;
      background-color: rgba(224, 224, 224, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 10;
      padding: 10px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .collapse-btn {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.8rem;
      background-color: var(--bg-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-color);
      transition: background-color 0.2s;
    }

    .collapse-btn:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>

  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">‚ò∞</button>

  <div class="page-container">

    <nav class="sidebar" id="sidebar">
      <div class="sidebar-content">

        {% include sidebar_fast.html %}
      </div>
      <div class="sidebar-resizer" id="sidebarResizer"></div>
    </nav>

    <main class="content">
      {{ content }}
    </main>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("sidebarToggle");
      const body = document.body;
      const sidebar = document.getElementById("sidebar");
      const sidebarContent = sidebar.querySelector('.sidebar-content');
      const resizer = document.getElementById("sidebarResizer");
      const collapseAllBtn = document.getElementById("collapseAllBtn");
      const STORAGE_KEY = "sidebar_collapsed";
      const WIDTH_KEY = "sidebar_width";
      const SCROLL_KEY = "sidebar_scroll_position";
      const DEFAULT_WIDTH = 280;

      // --- Helper Functions ---
      function updateTogglePosition(width) {
        if (!body.classList.contains("sidebar-collapsed")) {
          // Position near right edge: width - approx 40px
          toggleBtn.style.left = (width - 40) + "px";
        } else {
          toggleBtn.style.left = "20px";
        }
      }

      function setSidebarWidth(width) {
        sidebar.style.width = width + "px";
        updateTogglePosition(width);
      }

      // --- 1. Restore State ---
      // Width
      let savedWidth = parseInt(localStorage.getItem(WIDTH_KEY));
      if (!savedWidth || isNaN(savedWidth)) savedWidth = DEFAULT_WIDTH;
      setSidebarWidth(savedWidth);

      // Collapsed
      if (localStorage.getItem(STORAGE_KEY) === "true") {
        body.classList.add("sidebar-collapsed");
        updateTogglePosition(savedWidth); // Resets to 20px
      } else {
        updateTogglePosition(savedWidth);
      }

      // Scroll Position (Applied to sidebar-content now)
      const savedScroll = localStorage.getItem(SCROLL_KEY);
      if (savedScroll) {
        sidebarContent.scrollTop = parseInt(savedScroll, 10);
      }

      // --- 2. Event Listeners ---

      // Toggle
      toggleBtn.addEventListener("click", function () {
        body.classList.toggle("sidebar-collapsed");
        const isCollapsed = body.classList.contains("sidebar-collapsed");
        localStorage.setItem(STORAGE_KEY, isCollapsed);

        // Update position immediately
        const currentWidth = parseInt(sidebar.style.width, 10) || DEFAULT_WIDTH;
        updateTogglePosition(currentWidth);
      });



      // --- Debounce Helper ---
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      // Scroll Persistence (Debounced)
      sidebarContent.addEventListener("scroll", debounce(function () {
        localStorage.setItem(SCROLL_KEY, sidebarContent.scrollTop);
      }, 200));

      // --- 3. Drag Logic ---
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        console.log("Resizer mousedown triggered");
        isResizing = true;
        resizer.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none'; // Prevent text selection
        e.preventDefault(); // Stop default behavior
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        // Calculate new width
        let newWidth = e.clientX;
        console.log("Resizing to:", newWidth);

        // Constraints
        if (newWidth < 150) newWidth = 150;
        if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;

        setSidebarWidth(newWidth);
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          console.log("Resizer mouseup triggered");
          isResizing = false;
          resizer.classList.remove('resizing');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';

          // Save
          const currentWidth = parseInt(sidebar.style.width, 10);
          localStorage.setItem(WIDTH_KEY, currentWidth);
        }
      });
    });
  </script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
  <script>
    // Define helper functions globally
    window.highlightCode = function () {
      document.querySelectorAll('pre code').forEach((el) => {
        el.className = 'language-cpp';
        hljs.highlightElement(el);
      });
    };

    window.autoLinkContent = function () {
      const content = document.querySelector('.content');
      if (!content) return;

      const walker = document.createTreeWalker(
        content,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: function (node) {
            if (['A', 'SCRIPT', 'STYLE', 'PRE', 'CODE', 'TEXTAREA'].includes(node.parentNode.tagName)) {
              return NodeFilter.FILTER_REJECT;
            }
            return NodeFilter.FILTER_ACCEPT;
          }
        }
      );

      const nodes = [];
      let node;
      while (node = walker.nextNode()) nodes.push(node);

      // Regex for HTTP/HTTPS URLs
      const urlRegex = /https?:\/\/[^\s<"']+/g;

      nodes.forEach(node => {
        const text = node.nodeValue;
        if (text.indexOf('http') === -1) return;

        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        let match;

        urlRegex.lastIndex = 0;

        while ((match = urlRegex.exec(text)) !== null) {
          const url = match[0];
          const cleanUrl = url.replace(/[.,)\]]+$/, '');

          fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));

          const a = document.createElement('a');
          a.href = cleanUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = cleanUrl;
          fragment.appendChild(a);

          const stripped = url.substring(cleanUrl.length);
          if (stripped) {
            fragment.appendChild(document.createTextNode(stripped));
          }

          lastIndex = match.index + url.length;
        }

        if (lastIndex > 0) {
          if (lastIndex < text.length) {
            fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
          }
          node.parentNode.replaceChild(fragment, node);
        }
      });
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      window.highlightCode();
      window.autoLinkContent();
    });
  </script>
  <div class="text-size-footer">
    <div class="footer-left" style="position: absolute; left: 20px; display: flex; align-items: center; gap: 10px;">
      <button id="footerCollapseBtn" class="reset-btn" title="Collapse All Folders"
        style="font-size: 16px; margin: 0;">üìÇ</button>
      <input type="text" id="fuzzy-search-input" placeholder="Search..."
        style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
      <div id="search-stats" style="font-size: 10px; color: #666; white-space: nowrap;"></div>
    </div>
    <span style="font-size: 12px; font-weight: bold;">A</span>
    <input type="range" id="textSizeSlider" min="12" max="28" value="16" step="1">
    <span style="font-size: 24px; font-weight: bold;">A</span>
    <button id="resetTextSize" class="reset-btn">Default</button>
    <button id="editGithubBtn" class="reset-btn"
      style="margin-left: 20px; background-color: #e3f2fd; color: #0d47a1; border-color: #2196f3;">Edit in
      GitHub</button>
    <button id="editCodespaceBtn" class="reset-btn"
      style="margin-left: 10px; background-color: #e8f5e9; color: #1b5e20; border-color: #4caf50;">Edit in
      Codespace</button>
    <div class="footer-right" style="position: absolute; right: 20px; display: flex; align-items: center; gap: 10px;">
      <button id="backBtn" class="nav-btn" title="Previous Page">‚Üê Back</button>
      <button id="nextBtn" class="nav-btn" title="Next Page">Next ‚Üí</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const textSizeSlider = document.getElementById('textSizeSlider');
      const SIZE_KEY = "user_font_size";

      // 1. Restore State
      const savedSize = localStorage.getItem(SIZE_KEY);
      if (savedSize) {
        document.documentElement.style.setProperty('--base-font-size', savedSize + 'px');
        textSizeSlider.value = savedSize;
      }

      // 2. Listener
      textSizeSlider.addEventListener('input', function () {
        const newVal = this.value;
        document.documentElement.style.setProperty('--base-font-size', newVal + 'px');
        localStorage.setItem(SIZE_KEY, newVal);
      });

      // 3. Reset Button
      document.getElementById('resetTextSize').addEventListener('click', function () {
        const defaultSize = 16;
        document.documentElement.style.setProperty('--base-font-size', defaultSize + 'px');
        textSizeSlider.value = defaultSize;
        localStorage.setItem(SIZE_KEY, defaultSize);
      });

      // 4. Collapse All Button
      const collapseBtn = document.getElementById('footerCollapseBtn');
      if (collapseBtn) {
        collapseBtn.addEventListener('click', function () {
          // Select all details in the sidebar
          const allDetails = document.querySelectorAll('.sidebar-content details');
          allDetails.forEach(detail => {
            // Check if it is a root folder (direct child of .file-tree)
            const isRoot = detail.parentElement.parentElement.classList.contains('file-tree');

            // Option: Collapse everything that isn't the main list wrapper
            if (detail.hasAttribute('open') && !isRoot) {
              detail.removeAttribute('open');
              if (detail.id) localStorage.removeItem(detail.id);
            }
          });
        });
      }
    });
  </script>
  <!-- Editor Overlay -->


  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const editGithubBtn = document.getElementById('editGithubBtn');
      const editCodespaceBtn = document.getElementById('editCodespaceBtn');
      // Liquid variable for current path
      const currentPath = "{{ page.path }}";
      // GitHub Repo Details
      const githubUsername = "notecodium";
      const githubRepo = "notecodium.github.io";
      const branch = "main"; // Defaulting to main

      if (editGithubBtn) {
        editGithubBtn.addEventListener('click', function () {
          // Open GitHub Editor in new tab
          // Format: https://github.com/[user]/[repo]/edit/[branch]/[path]
          const githubUrl = `https://github.com/${githubUsername}/${githubRepo}/edit/${branch}/${currentPath}`;
          window.open(githubUrl, '_blank');
        });
      }

      if (editCodespaceBtn) {
        editCodespaceBtn.addEventListener('click', function () {
          // Open in VS Code Desktop
          // Protocol: vscode://github.codespaces/connect?name=[CODESPACE_NAME]
          const codespaceName = "ominous-train-97w54wjg45wghp975";
          const vscodeUrl = `vscode://github.codespaces/connect?name=${codespaceName}`;
          window.location.href = vscodeUrl;
        });
      }
    });

    // Navigation functionality
    async function initializeNavigation() {
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (!backBtn || !nextBtn) return;

      try {
        // Load files.json
        const response = await fetch('/assets/files.json');
        const files = await response.json();
        
        // Get current page path
        const currentPath = window.location.pathname;
        
        // Sort files exactly like the sidebar does
        const naturalSort = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' }).compare;
        
        // Build file tree structure like sidebar
        function buildFileTree(files) {
          const tree = {};
          const flatList = [];

          files.forEach(file => {
            const parts = file.dir.split('/').filter(p => p);
            let current = tree;

            parts.forEach(part => {
              if (!current[part]) {
                current[part] = { _files: [], _folders: {} };
              }
              current = current[part]._folders;
            });

            // Add file to the current folder
            const parentParts = parts.length > 0 ? parts : ['root'];
            let parent = tree;
            for (let i = 0; i < parts.length - 1; i++) {
              parent = parent[parts[i]]._folders;
            }
            if (parts.length > 0) {
              const lastPart = parts[parts.length - 1];
              if (!parent[lastPart]) {
                parent[lastPart] = { _files: [], _folders: {} };
              }
              parent[lastPart]._files.push(file);
            } else {
              if (!tree['root']) {
                tree['root'] = { _files: [], _folders: {} };
              }
              tree['root']._files.push(file);
            }
          });

          return tree;
        }

        // Render tree to flat list in sidebar order
        function renderTreeToFlatList(tree, level = 0) {
          let flatList = [];

          // Sort folders naturally
          Object.keys(tree).sort(naturalSort).forEach(key => {
            if (key === 'root') return;

            const node = tree[key];

            // Add files in this folder, sorted naturally
            if (node._files && node._files.length > 0) {
              node._files.sort((a, b) => naturalSort(a.name, b.name));
              flatList.push(...node._files);
            }

            // Recursively add files from subfolders
            if (Object.keys(node._folders).length > 0) {
              flatList.push(...renderTreeToFlatList(node._folders, level + 1));
            }
          });

          // Root level files
          if (tree['root'] && tree['root']._files) {
            tree['root']._files.sort((a, b) => naturalSort(a.name, b.name));
            flatList.push(...tree['root']._files);
          }

          return flatList;
        }

        // Build tree and get flat list in sidebar order
        const tree = buildFileTree(files);
        const sortedFiles = renderTreeToFlatList(tree);
        
        // Find current page index in sorted files array
        let currentIndex = -1;
        for (let i = 0; i < sortedFiles.length; i++) {
          if (sortedFiles[i].path === currentPath) {
            currentIndex = i;
            break;
          }
        }
        
        // If current page not found, disable navigation
        if (currentIndex === -1) {
          backBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }
        
        // Set up back button
        if (currentIndex > 0) {
          const prevFile = sortedFiles[currentIndex - 1];
          backBtn.disabled = false;
          backBtn.addEventListener('click', () => {
            // Scroll to previous file in sidebar before navigation
            scrollToFileInSidebar(prevFile.path);
            window.location.href = prevFile.path;
          });
        } else {
          backBtn.disabled = true;
        }
        
        // Set up next button
        if (currentIndex < sortedFiles.length - 1) {
          const nextFile = sortedFiles[currentIndex + 1];
          nextBtn.disabled = false;
          nextBtn.addEventListener('click', () => {
            // Scroll to next file in sidebar before navigation
            scrollToFileInSidebar(nextFile.path);
            window.location.href = nextFile.path;
          });
        } else {
          nextBtn.disabled = true;
        }
        
      } catch (error) {
        console.error('Error loading navigation:', error);
        backBtn.disabled = true;
        nextBtn.disabled = true;
      }
    }

    // Function to scroll to a specific file in the sidebar
    function scrollToFileInSidebar(targetPath) {
      const sidebarContent = document.querySelector('.sidebar-content');
      if (!sidebarContent) return;

      // Find the link for the target file
      const normalize = (p) => decodeURIComponent(p).replace(/\/$/, "").replace(/\.(html|md)$/, "");
      const normalizedTargetPath = normalize(targetPath);
      
      const links = Array.from(document.querySelectorAll('.file-link'));
      const targetLink = links.find(link => {
        const linkPath = normalize(new URL(link.href).pathname);
        return linkPath === normalizedTargetPath;
      });

      if (targetLink) {
        // Expand parent folders to ensure the link is visible
        let parent = targetLink.closest('details');
        while (parent) {
          parent.open = true;
          parent = parent.parentElement.closest('details');
        }

        // Smooth scroll to the target link
        setTimeout(() => {
          targetLink.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'nearest'
          });
        }, 100); // Small delay to allow folders to expand
      }
    }

    // Initialize navigation when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeNavigation);
  </script>
</body>

</html>